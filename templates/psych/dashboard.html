{% extends "psych/layout.html" %}
{% block psych_content %}

<section class="py-3">
  <h1 class="h4 mb-3">Дашборд психолога</h1>

  <!-- KPI карточки -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="p-3 bg-body-tertiary rounded-3">
        <div class="text-body-secondary small">Классов</div>
        <div class="fs-4 fw-bold">{{ (totals.classes or 0) | int }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 bg-body-terтиary rounded-3">
        <div class="text-body-secondary small">Учеников</div>
        <div class="fs-4 fw-bold">{{ (totals.students or 0) | int }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 bg-body-terтиary rounded-3">
        <div class="text-body-secondary small">Попыток за 30 дней</div>
        <div class="fs-4 fw-bold">{{ (totals.attempts_30d or 0) | int }}</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="p-3 bg-body-tertiary rounded-3">
        <div class="text-body-secondary small">Доступных тестов</div>
        <div class="fs-4 fw-bold">{{ (totals.tests_total or 0) | int }}</div>
      </div>
    </div>
  </div>

  <!-- Топ тестов + список классов -->
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body d-flex flex-column" style="min-height:320px;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Топ-10 тестов по активности (30 дней)</h6>
          </div>
          <div class="flex-grow-1">
            <canvas id="testsBar" style="width:100%; height:100%;"></canvas>
          </div>
          {% set _has_chart = tests_agg and (tests_agg|length > 0) %}
          {% if not _has_chart %}
            <div class="text-body-secondary small mt-2">Пока нет данных для графика.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <h6 class="mb-2">Классы</h6>
          <ul class="list-group small">
            {% for c in classes %}
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                 href="{{ url_for('psych.class_dashboard', class_id=c.id) }}">
                <span>{{ c.name }}</span>
                <i class="bi bi-chevron-right"></i>
              </a>
            {% else %}
              <li class="list-group-item text-body-secondary">Нет классов</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Последние попытки -->
  <div class="card border-0 shadow-sm mt-3">
    <div class="card-body">
      <h6 class="mb-2">Последние попытки</h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="small text-body-secondary">
            <tr>
              <th>Ученик</th>
              <th>Тест</th>
              <th>Статус</th>
              <th>Дата</th>
            </tr>
          </thead>
          <tbody>
          {% for a, t, u in recent_attempts %}
            <tr>
              <td>
                <a href="{{ url_for('psych.result_view', attempt_id=a.id) }}">
                  {{  t.title  }}
                </a>
              </td>
              <td>{{ t.title }}</td>
              <td>
                {% if a.finished_at %}
                  <span class="badge text-bg-success">Завершено</span>
                {% else %}
                  <span class="badge text-bg-secondary">В процессе</span>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if a.finished_at %}
                  {{ a.finished_at.strftime('%d.%m.%Y %H:%M') }}
                {% elif a.started_at %}
                  {{ a.started_at.strftime('%d.%m.%Y %H:%M') }}
                {% elif a.created_at %}
                  {{ a.created_at.strftime('%d.%м.%Y %H:%M') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="4" class="text-body-secondary">Пока нет данных</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- Скрытый JSON для графика -->
<!-- Скрытый JSON для графика (type меняем, чтобы IDE не парсила как JSON) -->
<script id="tests-data" type="application/x-json">
  {{ tests_chart_json|safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  (function () {
    const el = document.getElementById('testsBar');
    if (!el) return;

    const rawTag = document.getElementById('tests-data');
    let payload = {labels: [], values: []};
    try {
      if (rawTag && rawTag.textContent.trim()) {
        payload = JSON.parse(rawTag.textContent);
      }
    } catch (e) { /* ignore */ }

    const labels = Array.isArray(payload.labels) ? payload.labels : [];
    const values = (payload.values || []).map(v => Number(v) || 0);

    if (!labels.length || !values.length) return;

    new Chart(el, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Попыток', data: values, borderWidth: 1 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  })();
</script>


<!-- Chart.js один раз -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  (function () {
    const el = document.getElementById('testsBar');
    if (!el) return;

    const rawTag = document.getElementById('tests-data');
    let payload = {labels: [], values: []};
    try {
      if (rawTag && rawTag.textContent.trim()) {
        payload = JSON.parse(rawTag.textContent);
      }
    } catch (e) { /* ignore parse errors */ }

    const labels = Array.isArray(payload.labels) ? payload.labels : [];
    const values = (payload.values || []).map(v => Number(v) || 0);

    if (!labels.length || !values.length) return;

    new Chart(el, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Попыток', data: values, borderWidth: 1 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  })();
</script>

{% endblock %}
